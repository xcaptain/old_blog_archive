<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Python-encoding - Joey's Blog</title>
  <meta name="author" content="joey">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://xcaptain.github.io/blog/2015/01/13/python-encoding">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Joey's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://xcaptain.github.io/blog/2015/01/13/python-encoding">
  <meta property="og:title" content="Python-encoding - Joey's Blog">
  

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Joey's Blog</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a  href="/blog/categories/linux">Linux</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                            <input type="hidden" name="q" value="site:xcaptain.github.io">
                            <div class="form-group">
                                <input class="form-control" type="text" name="q" placeholder="Search">
                            </div>
                        </form>
                    </li>
                
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Joey's Blog" />
    <meta itemprop="description" content="不甘平凡" />
    <meta itemprop="url" content="http://xcaptain.github.io" />
    <article class="hentry" role="article" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
      
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-01-13T00:06:21+00:00"  data-updated="true" itemprop="datePublished dateCreated">2015-01-13</time>
        
      </p>
    
    
    <h1 class="entry-title" itemprop="name headline">
        Python-encoding
        
    </h1>
    
  </header>


<div class="entry-content clearfix" itemprop="articleBody description"><p>这篇文章是要记录今天写一个采集是遇到的编码问题的，但是因为在写博客时遇到了一些问题，所以也就顺便记录一下。</p>

<p>在执行rake new_post的时候，突然提示</p>

<pre>
rake aborted!
LoadError: cannot load such file -- bundler/setup
/home/joey/octopress/Rakefile:2:in `<top (required)>'
(See full trace by running task with --trace)
</pre>


<p>突然感觉很奇怪，前几天更新博客的时候都没有遇到这种情况，后来执行<code>rake --trace</code>的时候发现</p>

<pre>
/usr/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
/usr/lib/ruby/2.2.0/rubygems/core_ext/kernel_require.rb:54:in `require'
/home/joey/octopress/Rakefile:2:in `<top (required)>'
/usr/lib/ruby/2.2.0/rake/rake_module.rb:28:in `load'
/usr/lib/ruby/2.2.0/rake/rake_module.rb:28:in `load_rakefile'
/usr/lib/ruby/2.2.0/rake/application.rb:689:in `raw_load_rakefile'
/usr/lib/ruby/2.2.0/rake/application.rb:94:in `block in load_rakefile'
/usr/lib/ruby/2.2.0/rake/application.rb:176:in `standard_exception_handling'
/usr/lib/ruby/2.2.0/rake/application.rb:93:in `load_rakefile'
/usr/lib/ruby/2.2.0/rake/application.rb:77:in `block in run'
/usr/lib/ruby/2.2.0/rake/application.rb:176:in `standard_exception_handling'
/usr/lib/ruby/2.2.0/rake/application.rb:75:in `run'
/usr/bin/rake:33:in `<main>'
</pre>


<p>原来是系统ruby的版本更新到2.2了，以前是2.1的，octopress用的是2.1的gem，也许是和2.2的ruby不兼容吧，所以要重装2.2的gem套系，执行<code>proxychains gem install bundle</code>，有经验了必须要通过代理才能访问rubygem网站，下载完之后需要把<code>/home/joey/.gem/ruby/2.2.0/bin</code>添加到环境变量中，因为我用的是fish，所以编辑<code>~/.config/fish/config.fish</code>就行了。然后用bundle安装完必要的依赖<code>proxychains bundle install</code>，下载一大堆gem，最后发现系统用的rake已经是10.4.2版的了，而配置文件中需要的还是10.4.0,手动编辑一下<code>Gemfile.lock</code>，把版本号改过来就行了。ruby管理gem果然是够麻烦的，而且小版本升级也这么麻烦。</p>

<p>接下来就是说说今天写代码遇到的问题了。</p>

<p>需求很简单（话说写采集需求都很明确），这回需要的是采集明星的信息，第一个方案用的是采集baidu整理的明星信息，过程很简单，写了一个简单的脚本采了900条数据，但是后来发现图片做了防盗链，采集过来的图片不是图片的绝对路径，而是通过一台服务器生成的图片，也许是做了cookie的限制或者是做了ip的限制，导致每次刷新页面的时候都会返回一个403错误，链接在<a href="http://www.baidu.com/s?wd=%E6%98%8E%E6%98%9F%E5%A4%A7%E5%85%A8&amp;rsv_spt=1&amp;issp=1&amp;f=8&amp;rsv_bp=0&amp;rsv_idx=2&amp;ie=utf-8&amp;tn=baiduhome_pg&amp;rsv_enter=1&amp;rsv_sug3=4&amp;rsv_sug4=83&amp;rsv_sug1=3&amp;rsv_pq=d5fdf7cd00002ac7&amp;rsv_t=975c0jUWTeYgIUYA%2FfdqSJ75f%2BipUP9QR9v8Qgqb2jzy3rnHgTU3k4rBD%2B5moP73i00p&amp;rsv_sug2=0&amp;inputT=5564">这里</a>，以后有时间也许会去看看这个防盗链的实现，但是现在我可懒得花时间去研究怎么破解这个限制，那就换别的站采集吧。</p>

<p>和产品沟通了一下，他也觉得如果死扣baidu是不明智的选择，后来换成360整理的资源了，链接在<a href="http://www.haosou.com/s?ie=utf-8&amp;shb=1&amp;src=360sou_newhome&amp;q=%E6%98%8E%E6%98%9F%E5%A4%A7%E5%85%A8">这里</a>，数据也比较明确，分成3栏：领域，地域，性别，这个分类还是比较好的，以后我们拿来查询也方便。通过chrome开发工具，找到了js的接口，简单分析了一下就知道要获取那块数据，接下来就是敲代码了，最后的代码下面可以看到。</p>

<div><script src='https://gist.github.com/cbf9980f1b30b2467d8a.js?file=360_star.py'></script>
<noscript><pre><code>#!/usr/bin/python
# -*-coding: utf-8 -*-

import requests
from bs4 import BeautifulSoup
import pinyin
import mysql.connector
import sys

count_index = 0
def make_query(base_url, arg1, arg2, arg3):
    &#39;&#39;&#39;This function construct the real request address and returns the result&#39;&#39;&#39;
    addInfo = &#39;field:%s|area:%s|sex:%s&#39; % (arg1, arg2, arg3)
    payload = {
        &#39;query&#39;: &#39;明星大全&#39;,
        &#39;url&#39;: &#39;link&#39;,
        &#39;type&#39;: &#39;star_card&#39;,
        &#39;rank&#39;: &#39;1&#39;,
        &#39;addInfo&#39;: addInfo,
        &#39;d&#39;: &#39;pc&#39;,
        &#39;jsonpTest&#39;: &#39;on&#39;,
        &#39;_test&#39;: &#39;1&#39;,
        &#39;_debug&#39;: &#39;0&#39;,
        &#39;src&#39;: &#39;onebox&#39;,
        &#39;tpl&#39;: &#39;1&#39;
    }
    header = {&#39;User-Agent&#39;: &#39;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36&#39;}
    r = requests.get(base_url, params=payload)
    return r

def run():
    global count_index
    base_url = &#39;http://open.onebox.haosou.com/dataApi&#39;
    field_list = [&#39;明星&#39;, &#39;歌手&#39;, &#39;演员&#39;, &#39;模特&#39;, &#39;主持人&#39;, &#39;导演&#39;]
    area_list = [&#39;内地&#39;, &#39;香港&#39;, &#39;台湾&#39;, &#39;日本&#39;, &#39;韩国&#39;]
    sex_list = [&#39;男&#39;, &#39;女&#39;]
    conn = mysql.connector.connect(unix_socket=&#39;/run/mysqld/mysqld.sock&#39;, user=&#39;username&#39;, password=&#39;password&#39;, database=&#39;database&#39;, charset=&#39;utf8&#39;)
    for field in field_list:
        for area in area_list:
            for sex in sex_list:
                r = make_query(base_url, field, area, sex)
                if r.status_code == 200:
                    html_text = r.text
                    soup = BeautifulSoup(html_text, from_encoding=&#39;utf-8&#39;)
                    link_div = soup.find(&#39;div&#39;, {&#39;class&#39;: &#39;mh-datas&#39;})
                    links = link_div.text.strip(&#39;,&#39;)
                    links_list = links.split(&#39;,&#39;)
                    name_div = soup.find(&#39;div&#39;, {&#39;class&#39;: &#39;mh-names&#39;})
                    names = name_div.text.strip(&#39;,&#39;)
                    names_list = names.split(&#39;,&#39;)
                    write2db(conn, names_list, links_list, field, area, sex)
                    print(count_index)
                    count_index += 1
    conn.close()

def write2db(conn, names_list, links_list, field, area, sex):
    cur = conn.cursor()
    name_len = len(names_list)
    link_len = len(links_list)
    if name_len &lt;= link_len:
        l = name_len
    else:
        l = link_len
    for i in range(l):
        try:
            name = names_list[i]
            name_py = pinyin.get(name)
            link = links_list[i]
            sql = &quot;insert into 360_star(name, name_py, pic_link, field, area, sex) values(%s, %s, %s, %s, %s, %s)&quot;
            cur.execute(sql, (name, name_py, link,  field, area, sex))
        except UnicodeEncodeError:
            print(name)
            continue
    conn.commit()
    cur.close()

run()
</code></pre></noscript></div>


<p>在编码过程中遇到的问题有：
1. 使用python3而不是python2，因为用2我没法解决编码问题。
2. 使用了一个第三方的拼音库，能够把汉字转换成拼音，很不错，项目在<a href="http://lxyu.github.io/pinyin/">这里</a>
3. 使用mysql-connector而不是MySQLdb，这实在是无奈之举，因为python3中没有MySQLdb，所以只好使用自带的mysql-connector
4. 在使用mysql-connector连接数据库的时候发现一个问题，不能指定通过tcp的形式来连接，必须要用unix_socket，不知道为什么。</p>

<p>现在太晚了，为了避免影响室友休息，所以先列一个提纲，明天有时间再来详细补上。</p>
</div>


      <footer>
        <p class="meta text-muted">
          
<span class="glyphicon glyphicon-user"></span> <span class="byline author vcard" itemprop="author" itemscope itemtype="http://schema.org/Person">Posted by <span class="fn" itemprop="name">joey</span></span>

          










<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-01-13T00:06:21+00:00"  data-updated="true" itemprop="datePublished dateCreated">2015-01-13</time>
          

<span class="glyphicon glyphicon-tags"></span>&nbsp;
<span class="categories">
  
    <a class='category' href='/blog/categories/python/'>python</a>, <a class='category' href='/blog/categories/tips/'>tips</a>
  
</span>


        </p>
        
          <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://xcaptain.github.io/blog/2015/01/13/python-encoding/" data-via="" data-counturl="http://xcaptain.github.io/blog/2015/01/13/python-encoding/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

        
        
          <ul class="meta text-muted pager">
            
            <li class="previous"><a href="/blog/2015/01/05/play-with-git/" title="Previous Post: 玩弄git">&laquo; 玩弄git</a></li>
            
            
          </ul>
        
      </footer>
    </article>
    
  </div>

  
  <aside class="sidebar col-md-3">
    
      <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item active" href="/blog/2015/01/13/python-encoding/">Python-encoding</a>
    
    <a class="list-group-item " href="/blog/2015/01/05/play-with-git/">玩弄git</a>
    
    <a class="list-group-item " href="/blog/2015/01/03/debug-shadowsocks/">调试shadowsocks</a>
    
    <a class="list-group-item " href="/blog/2015/01/03/deploy-email-service/">部署邮件服务</a>
    
    <a class="list-group-item " href="/blog/2015/01/01/arch-pacman-broken/">解决pacman依赖关系破裂问题</a>
    
  </div>
</section>





<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Categories</h3>
  </div>
  <div class="list-group">
    
    
    <a class="list-group-item " href="/blog/categories/octopress/index.html">
      <span class="badge">1</span>
      octopress
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/web/index.html">
      <span class="badge">5</span>
      web
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/php/index.html">
      <span class="badge">3</span>
      php
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/unix/index.html">
      <span class="badge">1</span>
      unix
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/linux/index.html">
      <span class="badge">9</span>
      linux
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/shell/index.html">
      <span class="badge">1</span>
      shell
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/haskell/index.html">
      <span class="badge">2</span>
      haskell
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/fun/index.html">
      <span class="badge">2</span>
      fun
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/python/index.html">
      <span class="badge">3</span>
      python
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/emacs/index.html">
      <span class="badge">1</span>
      emacs
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/virtualization/index.html">
      <span class="badge">2</span>
      virtualization
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/git/index.html">
      <span class="badge">1</span>
      git
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/docker/index.html">
      <span class="badge">1</span>
      docker
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/vagrant/index.html">
      <span class="badge">1</span>
      vagrant
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/tips/index.html">
      <span class="badge">1</span>
      tips
    </a>
    
  </div>
</section>

    
  </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2015 - joey<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
