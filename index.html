<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Joey's Blog</title>
  <meta name="author" content="joey">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.iyue.club">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Joey's Blog" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://blog.iyue.club">
  <meta property="og:title" content="Joey's Blog">
  <meta property="og:description" content="不甘平凡">

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Joey's Blog</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
                <li >
                    <a  href="/blog/categories/linux">Linux</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <form class="search navbar-form navbar-right" action="https://www.google.com/search" method="GET">
                            <input type="hidden" name="q" value="site:blog.iyue.club">
                            <div class="form-group">
                                <input class="form-control" type="text" name="q" placeholder="Search">
                            </div>
                        </form>
                    </li>
                
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</nav>


      </header>
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Joey's Blog" />
    <meta itemprop="description" content="不甘平凡" />
    <meta itemprop="url" content="http://blog.iyue.club" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-07-14T18:05:40+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-07-14</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/07/14/php-coding-style/" itemprop="url">Php编码规范</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>之前写代码的时候一直不是很在意编码规范的问题，感觉只要把代码功能实现了就OK，但是看到越来越多的优秀开
源项目都给自己的项目制定了编码规范，提交PR必须要满足规范才能合并到主干，而且自己搞php开发也已经有1
年了，得开始走向规范化开发的道路。</p>

<p>首先得介绍一下psr2，目前<a href="http://laravel.com/">laravel</a>项目使用的就是这个风格标准，具体的规定
在<a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-2-coding-style-guide.md">这里</a>
我以前的习惯大部分符合psr2的标准，但是因为渐渐的使用到了很多高级的php特性，比如说closure, trait, 抽象类等，
所以还是得纠正一点小的习惯。</p>

<p>除了psr2这个标准之外，各大公司也有自己内部使用的标准，比如说symfony, wordpress, squiz等，还是靠拢
国际标准吧，目前我的emacs里面的php-mode的设置就是psr2的标准，自动格式化代码省了点心。</p>

<p>代码写完了之后提交到github上却总是发现过不了持续集成(Continuous Integration)的审核，我自己目前几个个人
项目使用的是<a href="https://styleci.io/">styleci</a>这个在线审核的工具，功能很简单但是很强大，最初几次提交
总是会给我返回很多fail，导致严格要求自己按照编码规范来。</p>

<p>为了避免提交之后被styleci给鄙视，从网上找到了<a href="https://github.com/squizlabs/PHP_CodeSniffer">PHP_CodeSniffer</a>这个
小工具，叫做php嗅探器，它其实包括2个小部件，一个是phpcs(php coding style)，另一个是phpcbf(PHP Code Beautifier and Fixer)，
前者只检查代码的问题，后者还会帮忙纠正代码，如果信不过机器帮忙纠正代码，那么之前一定的记得提交代码。根据官方文档上的
说明修改配置，简单使用，效果很不错。后来我又找了一个叫做<a href="https://github.com/nishimaki10/emacs-phpcbf">emacs-phpcbf</a>的
小工具，这个是一个emacs的插件配置好之后可以集成到php-mode里面，稍加配置就可以在保存php文件的时候自动纠正错误。</p>

<p>后面发现通过phpcbf纠错的代码还是不能通过styleci，找了一下发现styleci用的是一个叫做<a href="https://github.com/FriendsOfPHP/PHP-CS-Fixer">php-cs-fixer</a>
的引擎来审核代码的，又对照着装了一个php-cs-fixer，和phpcbf的功能差不多，但是稍微严格一点，对于额外的空行也会删掉。</p>

<p>码农要往正规化方向走，现在养成一下编码规范的习惯，以后再来培养测试驱动的习惯。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-06-23T15:09:46+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-06-23</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/06/23/migrate-a-discuz-site/" itemprop="url">迁移一个discuz站点</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>周五晚上帮同事迁移了一个网站，原来的<a href="http://www.huizu100.com">网站</a>是搭建在windows2003服务器上的，使用的是apache2 + php5.3 + mysql5.1 的架构，使用的是一个叫作PHPnow的一键安装包来管理服务器的，这种架构对于个人站长来说很方便，只要设置好了配置就可以自己搭建网站，但是扩展性特别差，简直就是没法维护，win2003本来就是老掉牙的技术了，这种服务器长期跑肯定是会有内存问题的，而用PHPnow搭建的网站，数据库，代码，数据都在一个目录里面，这样潜在的问题太大了，首先就是安全性问题，没有数据库本来应该单独放到一个专门的服务器上的。而且所有数据放在一起对于业务分离，备份也很不方便，一下备份一个几十G大的目录是很浪费资源的。</p>

<p>所以在我的建议下，周五晚上对这个网站做了一个迁移，新的架构是LNMP，ubuntu 15.04 server + nginx 1.6 + hhvm 3.7 + mariadb 10.0.20 + redis 3.0，当然因为服务器只有一台，所以没有做负载均衡，没有做数据库读写分离，也没有做hhvm的均衡，因为等我把环境搭建完的时候就已经很稳定了，所以暂时不打算那么做，下面简单的来说说迁移过程。</p>

<ol>
<li><p>服务器安装
我给的建议是装ubuntu，因为将来环境稳定下来之后要把权限分给站长，让他自己上去查看管理一些进程，而ubuntu的桌面又是比较简单易用的。本来他们是打算安装ubuntu 15.04 desktop版的，但是因为这个版本没法驱动DELL r710服务器自带的硬Raid，所以最后换成server版了。</p></li>
<li><p>nginx，mariadb，hhvm，redis这些软件的安装都很简单，唯一一个比较特殊的功能就是用了hhvm来替换php，不过暂时没有感到太大的性能提升。LNMP环境搭建是很简单的，很快就完成了。</p></li>
<li><p>接下来是服务器配置
最大的问题就是调整分区结构，服务器上有一块300G的自带硬盘，这款盘其实是由2块一样的硬盘搭建的raid0，自带了数据备份功能，所以这块盘理论上来说是不该保存太多系统以外的东西的。然后是1块1T的绿盘，这块盘的年头比较老了，以前的网站就部署在这块盘上，我打算把这个盘拿来当备份盘，还有一块2T的黑盘，这块盘是一块最新最好的数据盘，所以我打算把网站和数据库都放在这块盘上。首先要把这块2T的盘里面的数据备份了，很重要的资料一定得保存，但是里面用PHPNow的工具全量备份了站点，一个备份40G，备份一周的数据，复制这些内容浪费了好多时间。数据备份完了之后就是给硬盘分区，先分区那块2T的盘，准备分4个区，按照300+300+600+600来分，虽然暂时没有想好具体怎么使用，用<code>fdisk /dev/sdb</code>开始分区，分区之后就是创建文件系统，只用ext4，所以<code>mkfs.ext4 /dev/sdbn</code>。</p></li>
<li><p>部署网站
这步就很简单了，直接复制代码，修改配置，修改权限，有一个比较大的问题是discuz的图片是存放在一个叫做<code>data/attachment</code>的目录下的，这些图片完全可以和代码分离，所以拿一块额外的分区来装就行，我是挂载的那个600G的分区到这个目录的。<code>mount /dev/sdb6 /pathtodata/attachment</code>。</p></li>
</ol>


<p>部署完成之后调试了一下网站就跑起来了，但是还有很多要做的事，discuz的代码结构比较混乱，不好改动，而且原来他的网站语言设置是GBK的，涉及到编码问题又更加复杂了，反正直到周日晚上才把问题全部解决，目前就是陆陆续续做一些服务器的小性能调优。</p>

<p>6月25日更新：
这几天陆陆续续发现了一些bug，有样式错误的，有插件报错的，有缓存不能及时清的等等，突然感觉压力好大，工作日只能下班之后有时间做自己的事，端午节3天假2天加一晚上都折腾那个网站去了，本以为是没什么事了，没想到后续的问题更多更麻烦，早知道就不轻易答应人家了，而且以后坚决不再折腾discuz，继续折腾这个东西只会浪费我更多时间。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-06-07T23:56:19+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-06-07</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/06/07/learn-gulp/" itemprop="url">学习gulp</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>学习使用gulp来进行前端开发</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-06-03T23:27:17+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-06-03</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/06/03/use-powerline/" itemprop="url">上powerline</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>看到身边的同事好多都切换到zsh+powerline这样的组合了，总是在我面前炫耀操作git如何方便，用了很久一直没有更新<a href="https://github.com/oh-my-fish/oh-my-fish">oh-my-fish</a>之后，今晚总算是完全更新了一下配置，向更加高大上的方向进发。</p>

<p>首先是安装<a href="https://github.com/oh-my-fish/oh-my-fish">oh-my-fish</a>，这步还是很简单的，有一键安装脚本执行。</p>

<p>然后是安装<a href="https://github.com/powerline/powerline">powerline</a>，这是一个用python写的状态插件，以前我就在vim和emacs上用过，在我的urxvt上面还没有配置过，照着<a href="https://powerline.readthedocs.org/en/latest/">文档</a>简单配置了一下，也是很简单的，但是最后我发现我的urxvt终端模拟器没法使用默认的powerline字体，后来从<a href="https://github.com/powerline/fonts">这里</a>找到了几个字体补丁，把我的.Xresources文件修改一下之后就能使用powerline字体了，真是不错。</p>

<p>现在使用的主题是<a href="https://github.com/oh-my-fish/theme-agnoster">agnoster</a>，功能和配色都挺符合我的胃口的，默认支持powerline，git的状态显示也很不错。</p>

<p>顺便重新配置了一下tmux，以前多任务都是通过urxvt的新建tab来实现的，如果到了别的终端环境如何复用终端呢？还是使用tmux吧，而且也可以配置tmux使得它支持powerline，很不错的setup</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-06-01T23:44:13+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-06-01</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/06/01/learn-rails/" itemprop="url">学习rails</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>学习rails，自己做一个简单的rails项目。</p>

<ol>
<li><p><a href="https://github.com/plataformatec/devise">devise</a>验证权限</p></li>
<li><p><a href="http://www.postgresql.org/">postgresql</a>来持久化数据</p></li>
<li><p><a href="https://github.com/mperham/sidekiq">sidekiq</a>用来做队列</p></li>
<li><p><a href="https://github.com/sj26/mailcatcher">mailcatcher</a>用来捕获测试环境发放的邮件</p></li>
</ol>


<p>每个功能都有对应的gem，web开发真是简化了很多。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-06-01T14:34:01+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-06-01</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/06/01/learn-git/" itemprop="url">学习git</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>继续学习git，把统计后台的代码从内部git服务器迁移到github上面了，用的是自己的私有仓库。</p>

<p>目前主要用到的功能有：</p>

<ol>
<li><p>添加远程仓库
<code>git remote add origin https://github.com/xcaptain/simple-admin.git</code>
这样就能添加一个远程仓库了，等以后把代码push上去就行了，访问远程仓库的方式有2种，一种是ssh，一种是https，上面这种是https的仓库，也是github默认的访问仓库的方法，
因为ssh太不安全了，对于我们这种生活在封锁国度的老百姓来说，很容易被屏蔽。</p></li>
<li><p>往远程仓库里面提交代码
<code>git commit -m 'some comment'</code>
这样就可以提交代码，返回一个hash值标识的版本号，提交之后代码版本还在本地，如果要多方合作开发，那就得把改动保存到一个大家都可以访问的远程仓库，
<code>git push origin master</code>，把本地版本推送到远程的master分支。</p></li>
<li><p>建立本地分支
<code>git branch dev</code>
这样就在本地创建了一个叫做dev的分支，并且会自动切换到这个dev分支，如果建了好多个分支，想查看当前自己在哪个分支，直接<code>git branch</code>就会列出，当然如果使用的是zsh或者是
fish这样的shell，一般都会有git的插件，可以显示当前所在分支。</p></li>
<li><p>把本地分支添加到远程仓库
<code>git checkout dev</code>切换到dev分支，然后<code>git push origin dev</code>就可以把代码推送到远程仓库的dev分支了。</p></li>
<li><p>打标签
<code>git tag</code>可以查看当前版本库的所有标签信息，如果要添加标签，那么就是<code>git tag -a v0.2 -m '优化流量统计代码，统一风格'</code>添加一个叫作v0.2的标签，并且提交。如果要把
本地的标签信息提交到远程仓库，那么就是<code>git push --tags</code>，然后去github上查看就能看到对应的v0.2版本了。</p></li>
<li><p>查看提交版本
<code>git log</code>, <code>git diff</code>，我一般喜欢用emacs的magit插件来查看diff和版本。</p></li>
<li><p>把未暂存的文件回滚
<code>git checkout file1</code>，这样会从版本库中检出上一个提交的file1的版本，覆盖掉当前这个未提交的版本。</p></li>
<li><p>回滚版本库
这个操作目前做得比较少，都是<code>git reset --hard HEAD~1</code>，来回到上一个版本的，对于这个操作还不熟悉，至少svn回滚已经是很熟悉的了。</p></li>
</ol>


<p>git的功能很强大也很复杂，但是一定是要掌握的，这样才能成为一个合格的项目经理，以后慢慢积累，有新的体会再来更新这篇博客。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-05-23T15:58:40+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-05-23</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/05/23/php-getter/" itemprop="url">Php的getter方法</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>这几天做统计后台频繁用到一个叫做<a href="http://carbon.nesbot.com/">Carbon</a>的日期库，用多了发现这个库的接口设计得非常方便，方法非常自然，稍微用几次就知道用法了。比如说好多方法都是静态方法，省去了频繁构造对象的开销。最方便的还是里面的getter方法，<code>$dt-&gt;year</code>就返回了本年，这个year很明显是一个静态方法，因为$dt不是new出来的对象，但是我们看起来就好像是直接访问一个类的属性一样。</p>

<pre><code class="php">class A {
    public function year() {
        return 2015;
    }
    public static function __get($var) {
        return $this-&gt;$var();
    }
}
a = new A;
echo a-&gt;year;
</code></pre>

<p>是getter的一种简单写法，挺不错的。</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-05-20T23:11:20+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-05-20</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/05/20/learn-laravel-1/" itemprop="url">简单使用laravel</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>去年的时候就留意过<a href="http://laravel.com">laravel</a>这个框架了，对于这种类似rails风格的框架很是有好感，但是一直缺少一个实战操作的机会，让我在个人项目上用laravel是不可能的，追求的就是geek，个人项目暂时不考虑php这门语言。</p>

<p>公司有个简单的项目是做一个简单的统计后台，这个需求使用laravel就很简单了，可以省很多事。具体的代码我托管在<a href="https://github.com/xcaptain/simple-admin.git">github</a>了，想了一下主要的功能包括：</p>

<ol>
<li>登录注册</li>
<li>权限管理</li>
<li>脚本自动化</li>
<li>渲染页面</li>
</ol>


<p>登录注册好办，直接使用laravel自带的Auth库就行，自带的示例就内置了一个简单的登录注册页面。权限管理稍微有点麻烦，不过在github上搜了一下也找到好多个基于角色的权限控制的第三方库，我这里用的是<a href="http://github.com">entrust</a> 脚本自动化指的是后台的数据都来自脚本统计，所以必须要确保脚本能够正确的执行，使用laravel的schedule功能就很方便，可以在代码里面实现定时任务。渲染页面就更加简单了，简单的mvc模式，利用blade模板引擎可以写出很规范的模板。</p>

<p>在这个简单项目中，前端使用的是google开发的<a href="http://materialcss.com">materialcss</a>，类似与<a href="http://getbootstrap.com">bootstrap</a>，也是基于网格的设计，很方便初学者使用。前端数据可视化用到的是百度的<a href="http://www.baidu.com/">echart</a>库。</p>

<p>了解了基本的laravel就能很快上手了，比如说:</p>

<p><code>php artisan make:controller ExampleController</code>可以创建一个控制器。</p>

<p><code>php artisan make:model 'Models\Example'</code>可以创建一个模型，另外还会自动创建一个migrate，因为一个model总是对应着一张表的。</p>

<p><code>php artisan make:console UpdateData --command=update:data</code>会创建一条命令，执行<code>php artisan list</code>就能看到这条命令的介绍，去<code>App\Console\Commands\</code>下面就能找到对应的类了，要实现什么功能往这个类里面加方法就行了。</p>

<p><code>php artisan make:migration create_post_table</code>会自动在<code>database/migrations</code>目录下建立迁移文件，这个文件就是用来建表的，可以很方便的修改模式，而且还能记录开发过程中对表的修改。</p>

<p><code>php artisan migrate</code>会自动查找迁移文件，执行有必要的改动。</p>

<p><code>php artisan db:seed</code>可以自动给测试表填充内容，当然具体的实施得靠人来确定，框架是不可能知道要填入什么数据到哪张表的，对应的文件在<code>database/seeds/</code>下。</p>

<p>剩下的一些都是比较简单的，比如使用<a href="">Carbon</a>来操作时间，使用<a href="">Request</a>来获得http参数，用query builder来构造查询，用Eloquent来提交/读取model。还有一个比较强大的是laravel的路由功能，但是目前用到的还比较简单。</p>

<p>另外今天看到一篇文章，讲的是为什么laravel要放弃models目录，主要原因说的是对于现代web开发来说，MVC有点不够用了，除了model可以操作数据库，读写数据，但是对于别的业务，比如说发送邮件，请求第三方接口，记录日志等等，如果还是按照mvc来这些文件就不知道放哪里了，将决定权交给用户，真是很方便。</p>

<p>未来要做的事情主要包括：</p>

<ol>
<li>完善权限管理，目前只做了很简单的权限判断，还没有给admin帐号分配创建用户，创建角色的功能</li>
<li>整理路由配置，目前只做了2个简单的功能，但是路由就有点混乱了，得把页面分得清晰，构造优雅的url规则</li>
</ol>

</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-05-03T02:34:28+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-05-03</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/05/03/mysql-basics-1/" itemprop="url">Mysql基础</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>五一第二天泡国图看了一下午关于sql的书，小有所获，才发现以前工作中用到的只是mysql中的一个很小的子集，该好好整理一下了基础知识了，当然对于很基本，已经用得很熟练的知识就不提了。</p>

<h3>什么是sql语言</h3>

<p>sql语言包括：
    DDL（数据定义语言）：创建数据库，创建表，创建视图，创建索引等。
    DML（数据操作语言）：也就是增删改查操作。
    DCL（数据控制语言）：COMMIT，ROLLBACK，GRANT等。</p>

<h3>聚合查询</h3>

<p>聚合查询指的是把一张表的内容分组，相关操作包括<code>count</code>, <code>sum</code>, <code>min</code>, <code>max</code>, <code>avg</code>, <code>group by</code>, <code>having</code>，前面5个是聚合函数，从一大串结果中取出我们要的属性。
后面2个是分组的。<code>group by</code>的语法为:</p>

<pre><code class="sql">select &lt;col1&gt;, &lt;col2&gt;, &lt;col3&gt;
    from &lt;table_name&gt;
[where ...]
group by &lt;col1&gt;, &lt;col2&gt;, &lt;col3&gt;
[having ...]
</code></pre>

<p>有一条限制说的是select子句中的每一个字段都必须出现在group by的子句中，但是我在mysql和postgresql中执行的时候结果确不一样，pgsql有这个限制，而mysql则松散得多。在我看来必须得严格才行，不然在有1对多关系的表中，group by之后的结果可能会让人莫名其妙，难怪很多人都说postgresql比mysql要严谨。</p>

<h3>事务</h3>

<p>事务指的是把一系列操作封装在一起来执行，要么同时执行这一些列操作，要么一个都不执行。这个以前工作也用到的不多，可能公司是以前写代码的人对于这个也不看中吧，基本上都是直接update，insert了。记得以前用python的<code>MySQLdb</code>的时候，如果有插入操作必须手动调用一下commit方法才能把数据写进数据库，那时候还不理解，感觉多了一步操作实在是太麻烦了，现在看来把所有操作都看作事务来执行，手动提交事务对于数据来说还是很安全的。</p>

<p>事务有4个特性：（ACID）</p>

<ol>
<li>原子性（Atomic）：事务是一个整体。</li>
<li>一致性（Consistency）：每个操作都必须满足对应列的约束条件。</li>
<li>隔离性（Isolation）：没一个事务中的数据对另一个事务都是不可见的，在提交操作之前，数据不在表里面。</li>
<li>持久性（Duration）：每个事务完成之后会有日志记录，方便从日志恢复数据。</li>
</ol>


<p>创建事务：</p>

<pre><code class="sql">start | begin transaction
sql1;
sql2;
...
commit
</code></pre>

<p>现在仔细想想原来看过好多同时更新多张表的代码没有走事务，那些业务真是太危险了，一张表的结构出错可能就导致整个业务逻辑崩溃。</p>

<h3>视图</h3>

<p>视图类似与一张表，但是区别是表里面存放着数据，但是视图里面没有数据。可以用</p>

<pre><code class="sql">create view &lt;视图名&gt; [&lt;col1&gt;, &lt;col2&gt;]
as
select &lt;col1&gt;, &lt;col2&gt; ...
    from
&lt;表名&gt;
</code></pre>

<p>来创建一个视图。视图主要是为调用很频繁的sql做的，省得每次都得写一大段sql，视图还可以层叠，也就是cascade，不过这功能又太偏了，单用view就已经很少了。不过不知道在view中执行查询有没有比直接在表中查询快，如果仅仅是为了sql简洁就发明视图这个概念出来那也太浪费了吧。</p>

<p>视图是子查询的基础，子查询可以看作是一个视图。</p>

<h3>表的集合操作</h3>

<p>表在关系代数中其实就是集合，所以可以交集，并集，查集。</p>

<h3>表连结</h3>

<p>以前大学的时候学离散数学，数据库原理都讲了关系代数，但是才刚刚毕业一年就几乎忘光了，到目前只知道内联接外联接，连用形式化语言来描述连接都做不到，实在是辜负大学四年了，不过现在做应用开发，基本的理论知识看起来又有点鸡肋。</p>

<p>连接分为内联接，外联接。
inner join &lt;=> join
left outer join &lt;=> left join
right outer join &lt;=> right join
尽量避免直接写outer join，这样会使语义模糊。</p>

<h3>基本查询惯例</h3>

<ol>
<li>建表的时候用<code>primary key(id)</code>来创建主键，以前我都是喜欢写在一个列的限制性约束条件后面。</li>
<li>在表明不相等关系的时候使用<code>&lt;&gt;</code>而不是<code>!=</code>，前者才是标准写法。</li>
<li><code>char</code>类型是按照字典顺序来排序的，一直以来我都以为是按照ascii的顺序来排的。</li>
<li>在建表的时候尽量避免使用NULL这个变量，因为在查询中空值比较不好处理，不好比较大小，不好做运算，不好count，我也不打算去研究NULL在各种情况下的意义。判断一个字段是否为NULL用<code>IS NULL</code>来判断。</li>
</ol>

</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2015-04-17T17:33:16+08:00"  data-updated="true" itemprop="datePublished dateCreated">2015-04-17</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2015/04/17/php-meta-programming-1/" itemprop="url">一个简单的元编程的例子</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>去年在学习ruby的时候就看到了很多元编程的例子，用一个方法来生成多个类似的方法，避免制造重复的代码，ruby用的是method_missing来实现的。</p>

<p>今天工作遇到一个小问题，需要写一个简单的脚本来统计某个时间段用户的发帖信息，需求很简单要实现也很简单。最初的设计见下面：</p>

<pre><code class="php">class UpdateUserRank {
public function __construct() {}
public function getDayRank($num) {}
public function getMonthRank($num) {}
public function getAllRank($num) {}

public function setDayRank() {}
public function setMonthRank() {}
public function setAllRank() {}
}
</code></pre>

<p>需要写3个get方法，3个set方法，这种形式实在是太不方便维护了，每个函数的功能类似，而且函数名也类似，有没有什么办法能够不要写这么多函数呢？利用php的<code>__call</code>方法可以很简单的实现</p>

<pre><code class="php">class UpdateUserRank {
public function __construct() {
    $this-&gt;getMethods = array('getDayRank', 'getMonthRank', 'getAllRank');
    $this-&gt;setMethods = array('setDayRank', 'setMonthRank', 'setAllRank');
}
public function __call($name, $args) {
    if(in_array($name, $this-&gt;getMethods)) {
        $num = $args[0];
        return $this-&gt;redis-&gt;zrevrange($this-&gt;_key($name), 0, $num, true);
    } elseif(in_array($name, $this-&gt;setMethods)) {
        $nowtime = time();
        if($name == 'setDayRank') {
            $ago = $nowtime - 24 * 3600;
            $key = 'getDayRank';
        } elseif($name == 'setMonthRank') {
            $ago = $nowtime - 24 * 3600 * 30;
            $key = 'getMonthRank';
        } else {
            $ago = 0;
            $key = 'getAllRank';
        }
        $sql = "select authorid, count(authorid) as threadnum from dz_forum_thread where dateline between $ago and $nowtime group by authorid";
        $sth = $this-&gt;pdo-&gt;prepare($sql);
        $sth-&gt;execute();
        while($row = $sth-&gt;fetch(PDO::FETCH_ASSOC)) {
            $authorid = $row['authorid'];
            $threadnum = $row['threadnum'];
            $this-&gt;redis-&gt;zAdd($this-&gt;_key($key), $threadnum, $authorid);
        }
    } else {
        echo "不合法的方法: " . $name . "\n";
        exit(1);
    }
}
}
</code></pre>

<p>调用一个类里面的方法时，如果在当前类没有找到这个方法就会逐层往父类查找，直到找到对应的方法，但是如果这个类或者是父类定义了<code>__call</code>方法，则能自动处理找不到的方法，接受2个参数，第一个是函数名，第二个是函数名传过来的参数，是一个数组。基本上可以说<code>__call</code>实现了<code>method not defined</code>这个异常的处理吧。</p>

<p>因为php的正则没有ruby简单，所以在这里我先定义了2个数组，对象调用的方法必须在这2个数组中才能执行，否则就报不合法的方法，然后退出，也许还可以通过<code>__get</code>, <code>__set</code>来实现，谁知道呢？</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous"><a href="/posts/2">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2015/07/14/php-coding-style/">Php编码规范</a>
    
    <a class="list-group-item " href="/blog/2015/06/23/migrate-a-discuz-site/">迁移一个discuz站点</a>
    
    <a class="list-group-item " href="/blog/2015/06/07/learn-gulp/">学习gulp</a>
    
    <a class="list-group-item " href="/blog/2015/06/03/use-powerline/">上powerline</a>
    
    <a class="list-group-item " href="/blog/2015/06/01/learn-rails/">学习rails</a>
    
  </div>
</section>
<section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Categories</h3>
  </div>
  <div class="list-group">
    
    
    <a class="list-group-item " href="/blog/categories/octopress/index.html">
      <span class="badge">1</span>
      octopress
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/web/index.html">
      <span class="badge">6</span>
      web
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/php/index.html">
      <span class="badge">5</span>
      php
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/unix/index.html">
      <span class="badge">1</span>
      unix
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/linux/index.html">
      <span class="badge">12</span>
      linux
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/shell/index.html">
      <span class="badge">1</span>
      shell
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/haskell/index.html">
      <span class="badge">2</span>
      haskell
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/fun/index.html">
      <span class="badge">3</span>
      fun
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/python/index.html">
      <span class="badge">3</span>
      python
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/emacs/index.html">
      <span class="badge">2</span>
      emacs
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/virtualization/index.html">
      <span class="badge">2</span>
      virtualization
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/git/index.html">
      <span class="badge">1</span>
      git
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/docker/index.html">
      <span class="badge">1</span>
      docker
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/vagrant/index.html">
      <span class="badge">1</span>
      vagrant
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/tips/index.html">
      <span class="badge">1</span>
      tips
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/emacs,fish/index.html">
      <span class="badge">1</span>
      emacs,fish
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/emacs,/index.html">
      <span class="badge">1</span>
      emacs,
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/orgmode/index.html">
      <span class="badge">1</span>
      orgmode
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/sql,mysql,postgresql/index.html">
      <span class="badge">1</span>
      sql,mysql,postgresql
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/php,laravel,web/index.html">
      <span class="badge">1</span>
      php,laravel,web
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/git,linux/index.html">
      <span class="badge">1</span>
      git,linux
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/ruby,rails/index.html">
      <span class="badge">1</span>
      ruby,rails
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/linux,php,web/index.html">
      <span class="badge">1</span>
      linux,php,web
    </a>
    
    
    <a class="list-group-item " href="/blog/categories/web,php/index.html">
      <span class="badge">1</span>
      web,php
    </a>
    
  </div>
</section>

      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2015 - joey<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
